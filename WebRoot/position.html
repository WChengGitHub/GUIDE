
<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8"> 
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
    <title>HTML5定位</title>  
    <script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>  
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=wqBXfIN3HkpM1AHKWujjCdsi"></script>  
  <script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>  
    <style type="text/css">  
    *{ margin: 0px; padding: 0px;}  
  body{text-align: center;  height: 100%;overflow:hidden;}  
  #allmap{ width: 100%;height: 50%; position: absolute;}  
    </style>  
</head>  
<body>

	 <div id="allmap"></div>  
<script type="text/javascript"> 
  function getCookie()
   {
     //alert(document.cookie);
	 var strCookie=document.cookie;
	 alert(strCookie);
//将多cookie切割为多个名/值对
    var arrCookie=strCookie.split(";");
	//以分号分割开，把每一个cook键与对分开
    var Visitor="0";
    alert("aaarr:"+arrCookie.length);
    alert("helloWordl");
//遍历cookie数组，处理每个cookie对
   for(var i=0;i<arrCookie.length;i++){
             var arr=arrCookie[i].split("=");
             //找到名称为userId的cookie，并返回它的值，在与等号分开
             if("Visitor"==arr[0]){
			// alert(arr[0]);
                   Visitor=arr[1];
                   break;
             }
      }
     alert("sss:"+Visitor);
	if(Visitor=="0")
	 {
	 window.open("in.html");}
	 else{
	 Navigation();}
   }
 function Navigation(){  
     if(supportsGeoLocation()){  
        alert("你的浏览器支持 GeoLocation.");  
     }else{  
        alert("不支持 GeoLocation.")  
     }  
  // 检测浏览器是否支持HTML5  
               function supportsGeoLocation(){  
                return !!navigator.geolocation;  
              }    
  // 单次位置请求执行的函数               
               function getLocation(){  
                  navigator.geolocation.getCurrentPosition(mapIt,locationError);  
               }  
  //定位成功时，执行的函数  
              function mapIt(position){   
                 var lon = position.coords.longitude;  
                var lat = position.coords.latitude;  
                var map = new BMap.Map("allmap");  
                var point = new BMap.Point(""+lon+"",""+lat+"");  
                map.centerAndZoom(point,19); 
                var gc = new BMap.Geocoder();  
                      translateCallback = function (point){  
                         
                          var marker = new BMap.Marker(point);  
                          map.addOverlay(marker);  
                          map.setCenter(point);  
                          gc.getLocation(point, function(rs){  
                                var addComp = rs.addressComponents;  
                                if(addComp.province!==addComp.city){  
                                  var sContent =  
                                  "<div><h4 style='margin:0 0 5px 0;padding:0.2em 0'>你当前的位置是：</h4>" +   
                                  "<p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em'>"+addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber+"</p>" +   
                                  "</div>";}  
                                else{  
                                  var sContent =  
                                  "<div><h4 style='margin:0 0 5px 0;padding:0.2em 0'>你当前的位置是：</h4>" +   
                                  "<p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em'>"+ addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber+"</p>" +   
                                  "</div>";  
                                }
								var province=addComp.province;
								 var city=addComp.city;
                                  var area= addComp.district + addComp.street;
								  alert(province+" "+city+""+area);
                                var infoWindow = new BMap.InfoWindow(sContent);  
                                map.openInfoWindow(infoWindow,point); 
								sendRequest(province,city,area);
                          });   
                      }                      
                                         
                  BMap.Convertor.translate(point,0,translateCallback); 
				  
            }  
  // 定位失败时，执行的函数  
               function locationError(error)  
              {  
              switch(error.code)  
                {  
                case error.PERMISSION_DENIED:  
                  alert("User denied the request for Geolocation.");  
                  break;  
                case error.POSITION_UNAVAILABLE:  
                   alert("Location information is unavailable.");  
                  break;  
                case error.TIMEOUT:  
                   alert("The request to get user location timed out.");  
                  break;  
                case error.UNKNOWN_ERROR:  
                   alert("An unknown error occurred.");  
                  break;  
                }  
              }  
  // 页面加载时执行getLocation函数  
   getLocation();    
        } 
 function sendRequest(province,city,area)
 {alert("1");
 if(window.XMLHttpRequest)
 {
  xmlhttp=new XMLHttpRequest();
//创建一个XMLHttpRequest对象，用于在后台与服务器交换数据
 }
 else
 {
 xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
 //老版本使用ActiveX对象
 }
 alert("111");
 xmlhttp.onreadystatechange=function()
 {
   if(xmlhttp.readyState==4&&xmlhttp.status==200)
   {
     
   }
 }
 alert(1111);
 //这是一个onreadystatechange事件，readyState存有xmlhttp的状态，4代表请求已经完成，status：200表示OK，404表示找不到页面
 //responseText用于返回out.write()写的数据
 /* if(window.XMLHttpRequest){
    XMLHttpReq = new XMLHttpRequest();
 }else if(window.ActiveXObject){
    try{
        XMLHttpReq = new ActiveXObject("MSXML2.XMLHTTP");
    }catch(e){
        try{
           XMLHttpReq = new ActiveXObject("Mircsoft.XMLHTTP");
        }catch(e1){}
    }*/
   // alert("kkkkk");
    //var uname = document.myform.keyname.value;
    
   //提取表单数据
    alert(province+" "+city+""+area);
   var url="MyCookiel?province="+province+"&city="+city+"&area="+area;
   url=encodeURI(encodeURI(url));  
  //alert(url);
   // xmlhttp.open("GET",url,true);
   xmlhttp.open("post",url,true);
   //规定请求的类型，url,及是否进行异步处理
     alert(1);
     //XMLHTTpReq.open("POST","hello",true);
      xmlhttp.send();
    //把请求发送到服务器
      alert(2);
      //XMLHTTpReq.send(url);
 }
 
 getCookie();
</script>  
</body>  
</html>  

